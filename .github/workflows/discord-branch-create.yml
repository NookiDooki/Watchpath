name: Notify Discord on repo events

on:
  create:  # fires for new branches or tags
  push:
    branches:
      - main

jobs:
  notify:
    # only for branch creation events or pushes to main
    if: >-
      (github.event_name == 'create' && github.event.ref_type == 'branch') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
      - name: Post to Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          URL: ${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message || '' }}
          COMMIT_URL: ${{ github.event.head_commit.url || '' }}
          COMMITTER: ${{ github.event.head_commit.author.name || github.actor }}
          COMPARE_URL: ${{ github.event.compare || '' }}
        run: |
          set -euo pipefail
          if [ "$EVENT_NAME" = "create" ]; then
            jq -n --arg repo "$REPO" --arg branch "$BRANCH" --arg actor "$ACTOR" --arg url "$URL" \
              '{
                username: "Watchpath Bot",
                embeds: [{
                  title: "(๑˃ᴗ˂)ﻭ Nieuwe tak ontwaakt!",
                  description: ("**Repository**\\n`\($repo)`\\n\\n**Nieuwe tak**\\n`\($branch)`\\n\\n> _(✿◠‿◠) Veel succes met bouwen!_"),
                  url: $url,
                  color: 5814783,
                  fields: [
                    {name: "Creator", value: $actor, inline: true},
                    {name: "Jump In", value: $url, inline: true}
                  ],
                  timestamp: (now | todate),
                  footer: {text: "GitHub ➜ Discord"}
                }]
              }'
          else
            jq -n \
              --arg repo "$REPO" \
              --arg branch "$BRANCH" \
              --arg committer "$COMMITTER" \
              --arg message "$COMMIT_MESSAGE" \
              --arg commitUrl "$COMMIT_URL" \
              --arg compare "$COMPARE_URL" \
              '{
                username: "Watchpath Bot",
                embeds: [{
                  title: "(づ｡◕‿‿◕｡)づ Hoofdbranch bijgewerkt!",
                  url: $commitUrl,
                  color: 15418782,
                  fields: [
                    {name: "Commit", value: (if $commitUrl != "" then "[`View on GitHub`]($commitUrl)" else "`(pending)`" end), inline: true},
                    {name: "Diff", value: (if $compare != "" then "[`Compare changes`]($compare)" else "`n/a`" end), inline: true},
                    {name: "Author", value: $committer, inline: true}
                  ],
                  footer: {text: "Message"},
                  description: ("**Repository**\\n`\($repo)`\\n\\n**Branch**\\n`\($branch)`\\n\\n>>> \(if ($message | length) > 0 then $message else \"Geen commitbericht opgegeven.\" end)\\n\\n> _(＾▽＾) Samen verder bouwen!_"),
                  timestamp: (now | todate)
                }]
              }'
          fi \
          | curl -sSf -H "Content-Type: application/json" -d @- "$WEBHOOK_URL"
