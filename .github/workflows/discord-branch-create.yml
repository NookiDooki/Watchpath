name: Notify Discord on branch creation

on:
  create:  # fires for new branches or tags

jobs:
  notify:
    # only for branches (not tags)
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Post to Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          URL: ${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}
        run: |
          jq -n --arg repo "$REPO" --arg branch "$BRANCH" --arg actor "$ACTOR" --arg url "$URL" \
            '{
              embeds: [{
                title: "New branch created",
                description: ("**\($repo)**\n`\($branch)`"),
                url: $url,
                fields: [
                  {name: "Author", value: $actor, inline: true},
                  {name: "Link", value: $url, inline: false}
                ],
                timestamp: (now | todate),
                footer: {text: "GitHub â†’ Discord"}
              }]
            }' \
          | curl -sSf -H "Content-Type: application/json" -d @- "$WEBHOOK_URL"
